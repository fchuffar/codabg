---
title: "Test of a Codalab bundle"
output:
  html_document:
    number_sections: true
    toc: true
    toc_depth: 2
params:
  package_repository: "https://cloud.r-project.org"
  install_dependencies: true
  seed: 1
---


# Generate submission using starting kit

```{r label = "Bundle test - Knitr configuration", include = FALSE}
source(submission_script_R)
foo = sapply(names(alternative_programs), function (p) {generate_submission_files(alternative_programs[[p]], data_train, data_test, p)})
```

```{r label = "Bundle test - Knitr configuration", include = FALSE}
#  . echo = FALSE : don't include the source code in the finished file.
knitr::opts_chunk$set(echo    = FALSE)
##  . message = TRUE : includes messages that are generated by code in the finished file.
knitr::opts_chunk$set(message = TRUE)
##  . warning = TRUE : includes warnings that are generated by code in the finished file.
knitr::opts_chunk$set(warning = TRUE)
## . comment = '##' : a character string. Knitr will append the string to the start of each line of results in the final document.
knitr::opts_chunk$set(comment = "")
```

# Package dependencies

- R.utils   : to extract the arguments from the command line
- rmarkdown : to generate the R and html files from Rmd file

```{r label = "Bundle test - Package dependencies"}
if ( !exists(x = "params") ) {
    params                      <- NULL
}
if ( is.null(x = params$package_repository) ) {
    params$package_repository   <- "https://cloud.r-project.org"
}
if ( is.null(x = params$install_dependencies) ) {
    params$install_dependencies <- TRUE
}
if ( is.null(x = params$seed) ) {
    params$seed                 <- 1
}
print(params)
if ( params$install_dependencies ) {
    installed_packages <- installed.packages( )
    for (package in c("R.utils", "rmarkdown") ) {
        if ( !{ package %in% installed_packages } ) {
            print(x = paste("Installation of ", package, sep = "") )
            install.packages(
                pkgs = package
              , repos = params$package_repository
            )
        } else {
            print(x = paste(package, " is installed.", sep = "") )
        }
    }
    remove(list = c("installed_packages", "package") )
}
```

# Script options

```{r label = "Bundle test - Command line arguments", include = FALSE}
# User variables :
configuration <- R.utils::commandArgs(
    trailingOnly = FALSE
  , asValues     = TRUE
  , unique       = TRUE
)
```

Path of the directory with the files of the challenge : string between double quotes (preferably without white space). The working directory of R will then be set to this directory.
```{r label = "Bundle test - Challenge directory"}
if ( is.null(x = configuration$challenge_directory) ) {
    configuration$challenge_directory <- readline(prompt = paste0("Path of the directory with the files of the challenge. The working directory of R will then be set to this directory. (format : absolute or relative path) [default : ", getwd( ), "] : ") )
    if ( configuration$challenge_directory == "" ) {
        configuration$challenge_directory <- getwd( )
    }
}
print(x = configuration$challenge_directory)
stopifnot(exprs = dir.exists(paths = configuration$challenge_directory) )
setwd(dir = configuration$challenge_directory)
```

Path of the directory for the tests.
```{r label = "Bundle test - Directory tests"}
if ( is.null(x = configuration$tests_directory) ) {
    configuration$tests_directory <- readline(prompt = paste0("Path of the directory for the tests. (format : absolute or relative path) [default : tests] : ") )
    if ( configuration$tests_directory == "" ) {
        configuration$tests_directory <- "tests"
    }
}
print(x = configuration$tests_directory)
if ( !dir.exists(paths = configuration$tests_directory) ) {
    dir.create(path = configuration$tests_directory)
}
for ( dir in c(paste0("input", .Platform$file.sep, c("ref", "res") ), "output", "shared") ) {
    dirPath <- paste0(configuration$tests_directory, .Platform$file.sep, dir)
    if ( !dir.exists(paths = dirPath) ) {
        dir.create(path = dirPath, recursive = TRUE)
    }
}
remove(list = c("dir", "dirPath") )
```

Input data :
- path of the zip file :
```{r label = "Bundle test - Input data (zip file)"}
if ( is.null(x = configuration$input_data) ) {
    configuration$input_data <- readline(prompt = paste0("Path of the zip file for the input data. (format : absolute or relative path) [default : ", paste0("bundle", .Platform$file.sep, "starting_kit.zip"), "] : ") )
    if ( configuration$input_data == "" ) {
        configuration$input_data <- paste0("bundle", .Platform$file.sep, "starting_kit.zip")
    }
}
print(x = configuration$input_data)
stopifnot(exprs = file.exists( configuration$input_data ) )
```

- unzipped files :
```{r label = "Bundle test - Input data (files)"}
print(x = unzip(zipfile = configuration$input_data, list = TRUE) )
unzip(
    zipfile = configuration$input_data
  , exdir   = paste0(configuration$tests_directory, .Platform$file.sep, "input", .Platform$file.sep, "input")
)
```

Reference data :
- path of the zip file :
```{r label = "Bundle test - Reference data (zip file)"}
if ( is.null(x = configuration$reference_data) ) {
    configuration$reference_data <- readline(prompt = paste0("Path of the zip file for the reference data. (format : absolute or relative path) [default : ", paste0("bundle", .Platform$file.sep, "reference_data.zip"), "] : ") )
    if ( configuration$reference_data == "" ) {
        configuration$reference_data <- paste0("bundle", .Platform$file.sep, "reference_data.zip")
    }
}
print(x = configuration$reference_data)
stopifnot(exprs = file.exists( configuration$reference_data ) )
```

- unzipped files :
```{r label = "Bundle test - Reference data (files)"}
print(x = unzip(zipfile = configuration$reference_data, list = TRUE) )
unzip(
    zipfile = configuration$reference_data
  , exdir   = paste0(configuration$tests_directory, .Platform$file.sep, "input", .Platform$file.sep, "ref")
)
```

Path of the directory with the submissions.
```{r label = "Bundle test - Directory submissions"}
if ( is.null(x = configuration$submissions_directory) ) {
    configuration$submissions_directory <- readline(prompt = paste0("Path of the directory with the submissions. (format : absolute or relative path) [default : submissions] : ") )
    if ( configuration$submissions_directory == "" ) {
        configuration$submissions_directory <- "submissions"
    }
}
print(x = configuration$submissions_directory)
stopifnot(exprs = dir.exists(paths = configuration$submissions_directory) )
```

```{r label = "Bundle test - List of submissions", include = FALSE}
submissions_list <- list.files(path = configuration$submissions_directory)
zip_list         <- submissions_list[ grep(pattern = ".zip", x = submissions_list) ]
zip_program      <- zip_list[ grep(pattern = "program", x = zip_list) ]
zip_program      <- tail(x = sort(x = zip_program), n = 1)
zip_program      <- paste0(configuration$submissions_directory, .Platform$file.sep, zip_program)
zip_program_dir  <- sub(pattern = ".zip", replacement = "", x = zip_program)
zip_results      <- zip_list[ grep(pattern = "results", x = zip_list) ]
zip_results      <- tail(x = sort(x = zip_results), n = 1)
zip_results      <- paste0(configuration$submissions_directory, .Platform$file.sep, zip_results)
zip_results_dir  <- sub(pattern = ".zip", replacement = "", x = zip_results)
```

# Test of the ingestion program

Files inside the code submission (file : `r zip_program`) :
```{r label = "Bundle test - Submitted program"}
submission_program_dir <- sub(pattern = ".zip", replacement = "", x = zip_program)
print(x = unzip(zipfile = zip_program, list = TRUE) )
unzip(
    zipfile = zip_program
  , exdir   = submission_program_dir
)
```

## Options of the ingestion program :

- `ingestion_program`
```{r label = "Bundle test - Ingestion program - Ingestion program directory"}
if ( is.null(x = configuration$ingestion_program) ) {
    configuration$ingestion_program <- readline(prompt = paste0("Path of the directory with the ingestion program. (format : absolute or relative path) [default : ingestion_program] : ") )
    if ( configuration$ingestion_program == "" ) {
        configuration$ingestion_program <- "ingestion_program"
    }
}
print(x = configuration$ingestion_program)
stopifnot(exprs = dir.exists(paths = configuration$ingestion_program) )
ingestion_program <- configuration$ingestion_program
```

- `input`
```{r label = "Bundle test - Ingestion program - Input directory"}
input <- paste0(configuration$tests_directory, .Platform$file.sep, "input", .Platform$file.sep, "input")
print(x = input)
```

- `output`
```{r label = "Bundle test - Ingestion program - Output directory"}
output <- paste0(configuration$tests_directory, .Platform$file.sep, "input", .Platform$file.sep, "res")
print(x = output)
```

- `submission_program`
```{r label = "Bundle test - Ingestion program - Submission program directory"}
submission_program <- zip_program_dir
print(x = submission_program)
```

- `hidden`
```{r label = "Bundle test - Ingestion program - Hidden directory"}
hidden <- paste0(configuration$tests_directory, .Platform$file.sep, "input", .Platform$file.sep, "ref")
print(x = hidden)
```

- `shared`
```{r label = "Bundle test - Ingestion program - Shared directory"}
shared <- paste0(configuration$tests_directory, .Platform$file.sep, "shared")
print(x = shared)
```

## Command from the file `metadata`

- Command line to run the ingestion program :
```{r label = "Bundle test - Ingestion program - Command line"}
ingestion_command <- readLines(con = paste0(ingestion_program, .Platform$file.sep, "metadata"), n = 1)
ingestion_command <- gsub(pattern = "command: ", replacement = "", x = ingestion_command)
ingestion_command <- gsub(pattern = "\\$ingestion_program", replacement = ingestion_program, x = ingestion_command)
ingestion_command <- gsub(pattern = "\\$input" , replacement = input, x = ingestion_command)
ingestion_command <- gsub(pattern = "\\$output", replacement = output, x = ingestion_command)
ingestion_command <- gsub(pattern = "\\$submission_program", replacement = submission_program, x = ingestion_command)
ingestion_command <- gsub(pattern = "\\$hidden", replacement = hidden, x = ingestion_command)
ingestion_command <- gsub(pattern = "\\$shared", replacement = shared, x = ingestion_command)
print(x = ingestion_command)
```

- Run of the ingestion program :
```{r label = "Bundle test - Ingestion program - Run"}
system(command = ingestion_command)
```

- Output of the ingestion program :
```{r label = "Bundle test - Ingestion program - Output"}
print(x = list.files(path = output) )
remove(list = c("input", "output", "submission_program", "hidden", "shared") )
```

# Test of the scoring program

Files inside the code submission (file : `r zip_results`) :
```{r label = "Bundle test - Submitted results"}
submission_results_dir <- sub(pattern = ".zip", replacement = "", x = zip_results)
print(x = unzip(zipfile = zip_results, list = TRUE) )
unzip(
    zipfile = zip_results
  , exdir   = submission_results_dir
)
```

## Options of the scoring program :

- `scoring_program`
```{r label = "Bundle test - Scoring program - Scoring program directory"}
if ( is.null(x = configuration$scoring_program) ) {
    configuration$scoring_program <- readline(prompt = paste0("Path of the directory with the scoring program. (format : absolute or relative path) [default : scoring_program] : ") )
    if ( configuration$scoring_program == "" ) {
        configuration$scoring_program <- "scoring_program"
    }
}
print(x = configuration$scoring_program)
stopifnot(exprs = dir.exists(paths = configuration$scoring_program) )
scoring_program <- configuration$scoring_program
```

- `input`
```{r label = "Bundle test - Scoring program - Input directory"}
input <- paste0(configuration$tests_directory, .Platform$file.sep, "input")
print(x = input)
```

- `output`
```{r label = "Bundle test - Scoring program - Output directory"}
output <- paste0(configuration$tests_directory, .Platform$file.sep, "output")
print(x = output)
```

## Command from the file `metadata`

- Command line to run the scoring program :
```{r label = "Bundle test - Scoring program - Command line"}
scoring_command <- readLines(con = paste0(scoring_program, .Platform$file.sep, "metadata"), n = 1)
scoring_command <- gsub(pattern = "command: ", replacement = "", x = scoring_command)
scoring_command <- gsub(pattern = "\\$program", replacement = scoring_program, x = scoring_command)
scoring_command <- gsub(pattern = "\\$input" , replacement = input, x = scoring_command)
scoring_command <- gsub(pattern = "\\$output", replacement = output, x = scoring_command)
print(x = scoring_command)
```

- Run of the scoring program :
```{r label = "Bundle test - Scoring program - Run"}
system(command = scoring_command)
```

- Output of the scoring program :
```{r label = "Bundle test - Scoring program - Output"}
print(x = list.files(path = output) )
remove(list = c("input", "output") )
```
