---
title: "Submission script"
output:
  html_document:
    number_sections: true
    toc: true
    toc_depth: 2
    toc_float: true
params:
  package_repository: "https://cloud.r-project.org"
  install_dependencies: true
---

# Package dependencies
- zip : to generate the zip files that contain the programs or the results to submit to the Codalab platform.

```{r label = "Submission - dependencies", include = FALSE}
if ( !exists(x = "params") ) {
    params                      <- NULL
}
if ( is.null(x = params$package_repository) ) {
    params$package_repository   <- "https://cloud.r-project.org"
}
if ( is.null(x = params$install_dependencies) ) {
    params$install_dependencies <- TRUE
}
print(params)
if ( params$install_dependencies ) {
    installed_packages <- installed.packages( )
    for (package in c("zip") ) {
        if ( !{ package %in% installed_packages } ) {
            print(x = paste("Installation of ", package, sep = "") )
            install.packages(
                pkgs = package
              , repos = params$package_repository
            )
        } else {
            print(x = paste(package, " is installed.", sep = "") )
        }
    }
    remove(list = c("installed_packages", "package") )
}
```

# Format of the submission

- **For a code submission** : you have to make a zip file (no constrain on the namefile) that contains :
  - the file `metadata` that is generated by this script
  - your code inside a *R* file named `program.R`. This file will be sourced and have to contain :
    - a function `program` with `input` as argument : a matrix associated to your estimation.
  - any other files that you want to access from your function `program` : during the ingestion phase (when your code is evaluated), the working directory will be inside the directory obtained by unzipping your submission.
  
- **For a result submission** : you have to make a zip file (no constrain on the namefile), with your results as a matrix inside a rds file named `results.rds`.


# Configuration of your result

```{r label = "Submission - configuration", echo = TRUE, results = "verbatim"}
    ##
    ## EDIT THE FOLLOWING CODE BY COMMENTING/UNCOMMENTING THE REQUIRED PARTS
    ##
    
    ## define the public data set that you will use for your estimation :
    public_data <- readRDS(file = "public_data.rds")
```

# Write a function to estimate the parameters of mean and covariance

In the provided example, we use the empirical estimations of the mean and covariance.

```{r label = "Submission - Program", echo = TRUE, results = "verbatim"}
#' The function to estimate the mean and covariance parameters
#'
#' @param input a matrix
#' @return the estimated parameters
#' @examples
#' program(input = public_data)
program <- function(input) {
    ##
    ## YOUR CODE BEGINS HERE
    ##

    estimation            <- vector(mode = "list", length = 2)
    names(x = estimation) <- c("mean", "Sigma")

    estimation$mean  <- colMeans(x = input)
    estimation$Sigma <- cov(     x = input)
    
    return( estimation )
    
    ##
    ## YOUR CODE ENDS HERE
    ##
}
```

# Generate an estimation of the parameters of mean and covariance

```{r label = "Submission - Results", echo = TRUE, results = "verbatim"}
    ##
    ## DO NOT CHANGE THE FOLLOWING CODE
    ##

    ## we use the previously defined function 'program' to estimate A :
    res <- program(
        input = public_data
    )
```

# Generate a zip file with the 'program' source code

```{r label = "Submission - program zip file", echo = TRUE, results = "verbatim"}
## we save the source code as a R file named 'program.R' :
dump(list = c("program"), file = "program.R")
## we also generate the 'metadata' file
cat("command: Rscript $program/program.R $input $output", file = "metadata")

## we create the associated zip file :
zip_program <- paste0("program_", format(x = Sys.time( ), format = "%Y_%m_%d_%s"), ".zip")
zip::zipr(zipfile = zip_program, files = c("program.R", "metadata") )
print(x = zip_program)
```

# Generate a zip file with the estimation of the parameters of mean and covariance

```{r label = "Submission - results zip file", echo = TRUE, results = "verbatim"}
## we save the estimated A matrix as a rds file named 'results.rds' :
saveRDS(object = res, file = "results.rds" )

## we create the associated zip file :
zip_results <- paste0("results_", format(x = Sys.time( ), format = "%Y_%m_%d_%s"), ".zip")
zip::zipr(zipfile = zip_results, files = c("results.rds") )
print(x = zip_results)
```

# Submit the zip file

It generates the files *`r zip_program`*  and *`r zip_results`*  (the 1st one for code submission, the 2nd one for result submission).

Submit the zip submission file on the challenge in the tab `Participate`, menu `Submit / View Results` menu, sub-menu `CHALLENGE #1`, by clicking the `Submit` button after filling out some metadatas.

On the codalab challenge web page, The *STATUS* become : 
  - Submitting
  - Submitted	
  - Running
  - Finished

When it's finished :
  - You refresh the page and see your score
  - If enable, details for report could be downloaded by clicking *Download output from scoring step*.
  - Some logs are available to download.
  - Leader board is updated in the `Results` tab.

# Session Information

```{r, results="verbatim"}
sessionInfo( )
```
